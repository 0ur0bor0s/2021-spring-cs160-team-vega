import e,{useRef as t,useContext as r,useEffect as o}from"react";const s=e.createContext();s.displayName="ClientContext";var n=function(e){var t=e.name,r=e.type;this.uri=e.uri,this.name=t,this.type=r},i=function(e){return"undefined"!=typeof File&&e instanceof File||"undefined"!=typeof Blob&&e instanceof Blob||e instanceof n},a=function e(t,r,o){var s;void 0===r&&(r=""),void 0===o&&(o=i);var n=new Map;function a(e,t){var r=n.get(t);r?r.push.apply(r,e):n.set(t,e)}if(o(t))s=null,a([r],t);else{var c=r?r+".":"";if("undefined"!=typeof FileList&&t instanceof FileList)s=Array.prototype.map.call(t,(function(e,t){return a([""+c+t],e),null}));else if(Array.isArray(t))s=t.map((function(t,r){var s=e(t,""+c+r,o);return s.files.forEach(a),s.clone}));else if(t&&t.constructor===Object)for(var u in s={},t){var h=e(t[u],""+c+u,o);h.files.forEach(a),s[u]=h.clone}else s=t}return{clone:s,files:n}};const c=e=>i(e)||null!==e&&"object"==typeof e&&"function"==typeof e.pipe;class u{constructor(e={}){if(!e.url)throw Error("GraphQLClient: config.url is required");if(e.fetch&&"function"!=typeof e.fetch)throw Error("GraphQLClient: config.fetch must be a function");if(("undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement||e.ssrMode)&&!e.fetch&&!fetch)throw Error("GraphQLClient: fetch must be polyfilled or passed in new GraphQLClient({ fetch })");if(e.ssrMode&&!e.cache)throw Error("GraphQLClient: config.cache is required when in ssrMode");this.cache=e.cache,this.headers=e.headers||{},this.ssrMode=e.ssrMode,this.ssrPromises=[],this.url=e.url,this.fetch=e.fetch||"undefined"!=typeof fetch&&fetch&&fetch.bind(),this.fetchOptions=e.fetchOptions||{},this.FormData=e.FormData||("undefined"!=typeof FormData?FormData:void 0),this.logErrors=void 0===e.logErrors||e.logErrors,this.onError=e.onError,this.useGETForQueries=!0===e.useGETForQueries,this.subscriptionClient=e.subscriptionClient}setHeader(e,t){return this.headers[e]=t,this}setHeaders(e){return this.headers=e,this}removeHeader(e){return delete this.headers[e],this}logErrorResult({result:e,operation:t}){console.error("GraphQL Hooks Error"),console.groupCollapsed("---\x3e Full Error Details"),console.groupCollapsed("Operation:"),console.log(t),console.groupEnd();const r=e.error;r&&(r.fetchError&&(console.groupCollapsed("FETCH ERROR:"),console.log(r.fetchError),console.groupEnd()),r.httpError&&(console.groupCollapsed("HTTP ERROR:"),console.log(r.httpError),console.groupEnd()),r.graphQLErrors&&r.graphQLErrors.length>0&&(console.groupCollapsed("GRAPHQL ERROR:"),r.graphQLErrors.forEach((e=>console.log(e))),console.groupEnd())),console.groupEnd()}generateResult({fetchError:e,httpError:t,graphQLErrors:r,data:o}){return!!(r&&r.length>0||e||t)?{data:o,error:{fetchError:e,httpError:t,graphQLErrors:r}}:{data:o}}getCacheKey(e,t={}){return{operation:e,fetchOptions:{...this.fetchOptions,...t.fetchOptionsOverrides}}}getCache(e){const t=this.cache?this.cache.get(e):null;if(t)return t}saveCache(e,t){this.cache&&this.cache.set(e,t)}getFetchOptions(e,t={}){const r={method:"POST",headers:{...this.headers},...this.fetchOptions,...t};if("GET"===r.method)return r;const{clone:o,files:s}=a(e,"",c),n=JSON.stringify(o);if(s.size){if(!this.FormData)throw Error("GraphQLClient: FormData must be polyfilled or passed in new GraphQLClient({ FormData })");const e=new this.FormData;e.append("operations",n);const t={};let o=0;s.forEach((e=>{t[++o]=e})),e.append("map",JSON.stringify(t)),o=0,s.forEach(((t,r)=>{e.append(""+ ++o,r,r.name)})),r.body=e}else r.headers["Content-Type"]="application/json",r.body=n;return r}request(e,t={}){let r=this.url;if("GET"===this.getFetchOptions(e,t.fetchOptionsOverrides).method){r=r+"?"+Object.entries(e).filter((([,e])=>!!e)).map((([e,t])=>("variables"===e&&(t=JSON.stringify(t)),`${e}=${encodeURIComponent(t)}`))).join("&")}return this.fetch(r,this.getFetchOptions(e,t.fetchOptionsOverrides)).then((e=>e.ok?e.json().then((({errors:e,data:t})=>this.generateResult({graphQLErrors:e,data:t}))):e.text().then((t=>{const{status:r,statusText:o}=e;return this.generateResult({httpError:{status:r,statusText:o,body:t}})})))).catch((e=>this.generateResult({fetchError:e}))).then((t=>(t.error&&(this.logErrors&&this.logErrorResult({result:t,operation:e}),this.onError&&this.onError({result:t,operation:e})),t)))}createSubscription(e){if(!this.subscriptionClient)throw Error("No SubscriptionClient! Please set in the constructor.");return this.subscriptionClient.request(e)}}var h=Object.prototype.hasOwnProperty;function l(e,t,r){for(r of e.keys())if(f(r,t))return r}function f(e,t){var r,o,s;if(e===t)return!0;if(e&&t&&(r=e.constructor)===t.constructor){if(r===Date)return e.getTime()===t.getTime();if(r===RegExp)return""+e==""+t;if(r===Array){if((o=e.length)===t.length)for(;o--&&f(e[o],t[o]););return-1===o}if(r===Set){if(e.size!==t.size)return!1;for(o of e){if((s=o)&&"object"==typeof s&&!(s=l(t,s)))return!1;if(!t.has(s))return!1}return!0}if(r===Map){if(e.size!==t.size)return!1;for(o of e){if((s=o[0])&&"object"==typeof s&&!(s=l(t,s)))return!1;if(!f(o[1],t.get(s)))return!1}return!0}if(r===ArrayBuffer)e=new Uint8Array(e),t=new Uint8Array(t);else if(r===DataView){if((o=e.byteLength)===t.byteLength)for(;o--&&e.getInt8(o)===t.getInt8(o););return-1===o}if(ArrayBuffer.isView(e)){if((o=e.byteLength)===t.byteLength)for(;o--&&e[o]===t[o];);return-1===o}if(!r||"object"==typeof e){for(r in o=0,e){if(h.call(e,r)&&++o&&!h.call(t,r))return!1;if(!(r in t)||!f(e[r],t[r]))return!1}return Object.keys(t).length===o}}return e!=e&&t!=t}const p="RESET_STATE",d="LOADING",g="CACHE_HIT",E="REQUEST_RESULT";function y(e,t){switch(t.type){case p:return t.initialState;case d:return e.error?{...t.initialState,data:e.data,loading:!0}:e.loading?e:{...e,loading:!0};case g:return e.cacheHit&&!t.resetState?e:{...t.result,cacheHit:!0,loading:!1};case E:return{...t.result,data:e.data&&t.result.data&&t.updateData?t.updateData(e.data,t.result.data):t.result.data,cacheHit:!1,loading:!1};default:return e}}function b(t,r={}){if("string"!=typeof t)throw Error("Your query must be a string. If you are using the `gql` template literal from graphql-tag, remove it from your query.");const o=e.useContext(s),n=r.client||o,i=e.useRef(!0),a=e.useRef(null),c={query:t,variables:r.variables,operationName:r.operationName,persisted:r.persisted};(r.persisted||n.useGETForQueries&&!r.isMutation)&&(r.fetchOptionsOverrides={...r.fetchOptionsOverrides,method:"GET"});const u=n.getCacheKey(c,r),h=r.isMutation||r.isManual,l=r.skipCache||!n.cache?null:n.cache.get(u),b={...l,cacheHit:!!l,loading:!h&&!l},[m,C]=e.useReducer(y,b),v=JSON.stringify(u);e.useEffect((()=>{r.updateData||C({type:p,initialState:b})}),[v]),e.useEffect((()=>(i.current=!0,()=>{i.current=!1})),[]);const O=function(t,r){const o=e.useRef();return f(r,o.current)||(o.current=r),e.useCallback(t,o.current)}((e=>{if(!i.current)return Promise.resolve();const t={...r,...e},o={...c,variables:t.variables,operationName:t.operationName},s=n.getCacheKey(o,t);a.current=s;const u=t.skipCache?null:n.getCache(s);return u?(C({type:g,result:u,resetState:v!==JSON.stringify(m.cacheKey)}),Promise.resolve(u)):(C({type:d,initialState:b}),n.request(o,t).then((e=>{if(t.updateData&&"function"!=typeof t.updateData)throw Error("options.updateData must be a function");const r={...e};if(t.useCache&&(r.useCache=!0,r.cacheKey=s,n.ssrMode)){const e={error:r.error,data:t.updateData?t.updateData(m.data,r.data):r.data};n.saveCache(s,e)}return i.current&&s===a.current&&C({type:E,updateData:t.updateData,result:r}),e})))}),[n,r,c]);e.useEffect((()=>{m.useCache&&n.saveCache(m.cacheKey,m)}),[n,m]);return[O,m,(e={})=>C({type:p,initialState:{...b,...e}})]}const m={useCache:!0};function C(t,r={}){const o={...m,...r},n=e.useContext(s),i=r.client||n,[a,c]=e.useState(!1),[u,h]=b(t,o);if(i.ssrMode&&!1!==r.ssr&&!a&&!r.skipCache){if(!h.data&&!h.error){const e=u();i.ssrPromises.push(e)}c(!0)}const l=JSON.stringify(o);return e.useEffect((()=>{u()}),[t,l]),{...h,refetch:e.useCallback(((e={})=>u({skipCache:!0,updateData:(e,t)=>t,...e})),[u])}}function v(e,n){const i=t(n);i.current=n;const a=r(s),c=e.client||a,u={query:e.query,variables:e.variables};o((()=>{const e=c.createSubscription(u).subscribe({next:e=>{i.current(e)},error:()=>{e.unsubscribe()},complete:()=>{e.unsubscribe()}});return()=>{e.unsubscribe()}}),[])}const O=(e,t)=>b(e,{useCache:!0,isManual:!0,...t}),w=(e,t)=>b(e,{isMutation:!0,...t});export{s as ClientContext,u as GraphQLClient,b as useClientRequest,O as useManualQuery,w as useMutation,C as useQuery,v as useSubscription};
